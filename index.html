<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Test ePub.js + JSZip (CDN, nessun errore)</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 30px auto;
    }
    h1 {
      text-align: center;
    }
    #render-area {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      min-height: 300px;
    }
    #message {
      margin: 10px 0;
      color: #333;
    }
    .btn {
      background-color: #2196F3;
      color: #fff;
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      margin-left: 5px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Carica EPUB con ePub.js (JSZip da CDN)</h1>

  <p>Seleziona un file EPUB: <input type="file" id="fileInput" accept=".epub" /></p>
  <button class="btn" id="loadBtn" disabled>Carica EPUB</button>
  <div id="message"></div>

  <!-- Area in cui ePub.js renderizza l'EPUB -->
  <div id="render-area"></div>

  <!-- 1) Carichiamo JSZip dal CDN (PRIMA di ePub.js) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- 2) Carichiamo ePub.js dal CDN (che troverà JSZip) -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>

  <!-- 3) Nostro script: utilizza ePub(...) senza errori di JSZip -->
  <script>
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');
    const messageEl = document.getElementById('message');
    const renderArea = document.getElementById('render-area');

    let selectedFile = null;
    let book = null; // ePub.js Book

    // Quando selezioniamo un file, abilitiamo il pulsante Carica
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length > 0) {
        selectedFile = fileInput.files[0];
        loadBtn.disabled = false;
      }
    });

    // Clic "Carica EPUB": leggiamo il file e lo passiamo a ePub.js
    loadBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      loadBtn.disabled = true;
      messageEl.textContent = "Caricamento in corso...";

      try {
        // Leggiamo il file come ArrayBuffer
        const arrayBuffer = await readFileAsArrayBuffer(selectedFile);

        // Istanziamo l'EPUB con ePub.js (che userà JSZip)
        book = ePub(arrayBuffer);

        // Renderizziamo nell'elemento #render-area
        const rendition = book.renderTo(renderArea, {
          width: '100%',
          height: '600px'
        });
        
        // Visualizziamo il primo capitolo
        await rendition.display();

        messageEl.textContent = "EPUB caricato correttamente!";
      } catch (err) {
        console.error(err);
        messageEl.textContent = "Errore caricando l'EPUB: " + err;
        loadBtn.disabled = false;
      }
    });

    // Utility: legge un file come ArrayBuffer
    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
  </script>
</body>
</html>
